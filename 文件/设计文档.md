### 基于Hadoop的气象数据分析平台设计文档

---

#### **1. 项目概述**
本项目旨在构建一个基于Hadoop和Hive的气象数据分析平台，通过HDFS存储海量气象数据，利用Hive构建数据仓库并执行分析任务，后端采用Spring Boot提供数据接口，前端通过图表展示分析结果。核心目标是为气象研究和预报提供数据支持，包括趋势分析、地理分布、相关性分析等。

---

#### **2. 系统架构设计**
- **数据存储层**：HDFS存储原始气象数据（CSV/JSON格式）。
- **数据处理层**：Hive数据仓库，通过Hive SQL执行批量分析。
- **后端服务层**：Spring Boot提供RESTful API，集成Hive JDBC执行查询。
- **前端展示层**：Vue.js + ECharts，展示折线图、热力图等可视化结果。

架构示意：用户上传数据至HDFS → Hive数仓处理 → Spring Boot API查询 → 前端图表展示

---

#### **3. 数据流程设计**
1. **数据采集**：  
   - 来源：公开气象站数据（如NOAA）或模拟数据生成工具。  
   - 字段：时间戳、温度、湿度、风速、气压、气象站ID、经纬度。  
   - 格式：CSV文件，示例：  
     ```csv
     timestamp,temperature,humidity,wind_speed,pressure,station_id,latitude,longitude
     2023-01-01 12:00:00,25.5,60,10.2,1013.2,ST001,39.9042,116.4074
     ```

2. **数据上传**：  
   - Spring Boot提供文件上传接口，调用HDFS API将数据存入 `/weather/raw` 目录。  
   - 数据清洗：过滤缺失值（如湿度为-9999的异常记录）。

3. **数仓搭建**：  
   - Hive表定义（按时间分区）：  
     ```sql
     CREATE EXTERNAL TABLE weather_data (
         station_id STRING,
         temperature DOUBLE,
         humidity DOUBLE,
         wind_speed DOUBLE,
         pressure DOUBLE,
         latitude DOUBLE,
         longitude DOUBLE
     )
     PARTITIONED BY (event_time STRING)
     ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
     LOCATION '/weather/hive';
     ```

4. **数据分析**：通过Hive SQL执行查询，结果存入HDFS或MySQL供前端调用。

---

#### **4. 功能模块详细设计**
- **数据管理模块**：  
  - 文件上传接口（POST `/api/upload`）。  
  - 数据清洗逻辑（过滤无效值，格式转换）。  

- **数据分析模块**：  
  - 基础统计：月平均温度、最高风速、湿度分布。  
  - 趋势分析：年度温度变化、季节性气压波动。  
  - 地理分析：不同区域的湿度/风速热力图。  
  - 相关性分析：温度与湿度的相关系数。  

- **可视化模块**：  
  - 折线图展示温度趋势。  
  - 热力图展示区域湿度分布。  
  - 散点图呈现温度-湿度相关性。  

---

#### **5. 数据分析方法与Hive SQL示例**
1. **月平均温度计算**：  
   ```sql
   SELECT 
       SUBSTR(event_time, 1, 7) AS month,
       AVG(temperature) AS avg_temp
   FROM weather_data
   GROUP BY SUBSTR(event_time, 1, 7);
   ```

2. **地区湿度分布**：  
   ```sql
   SELECT 
       CONCAT(latitude, ',', longitude) AS location,
       AVG(humidity) AS avg_humidity
   FROM weather_data
   GROUP BY latitude, longitude;
   ```

3. **温度-湿度相关性分析**：  
   ```sql
   SELECT 
       CORR(temperature, humidity) AS correlation
   FROM weather_data;
   ```

4. **年度极端风速检测**：  
   ```sql
   SELECT 
       station_id,
       MAX(wind_speed) AS max_wind_speed
   FROM weather_data
   WHERE wind_speed > 20  -- 定义风速阈值
   GROUP BY station_id;
   ```

---

#### **6. 接口设计（REST API）**
- **数据上传**：  
  `POST /api/upload`  
  请求体：CSV文件，响应：HDFS存储路径。  

- **查询接口**：  
  - 温度趋势：`GET /api/analysis/temperature?year=2023`  
    响应：`{ "months": ["2023-01", ...], "temps": [25.5, ...] }`  
  - 湿度分布：`GET /api/analysis/humidity`  
    响应：`[ { "location": "39.9,116.4", "value": 60 }, ... ]`  

---

#### **7. 部署与运行环境**
- **Hadoop集群**：3节点（1 NameNode + 2 DataNode）。  
- **Hive**：MetaStore使用MySQL，Thrift Server提供JDBC连接。  
- **Spring Boot**：部署在Tomcat，配置Hive数据源。  
- **前端**：Nginx托管静态页面，调用后端API。  

---

#### **8. 优化与扩展**
- **性能优化**：  
  - Hive表按时间和地区分区。  
  - 使用ORC格式存储数据，提升查询速度。  
- **扩展功能**：  
  - 实时分析：集成Spark Streaming处理实时数据流。  
  - 预测模型：调用Python ML模型进行温度预测。  



# 数据分析

## 极端天气分析

### 年度极端温度分析

```
-- 每年最高/最低温度及发生日期
SELECT 
    year,
    MAX(temperature) AS max_temp,
    MIN(temperature) AS min_temp,
    MAX(CASE WHEN temperature = max_temp THEN CONCAT(month,'-',day) END) AS max_temp_date,
    MIN(CASE WHEN temperature = min_temp THEN CONCAT(month,'-',day) END) AS min_temp_date
FROM (
    SELECT 
        year, month, day, temperature,
        MAX(temperature) OVER (PARTITION BY year) AS max_temp,
        MIN(temperature) OVER (PARTITION BY year) AS min_temp
    FROM weather_analysis
) t
GROUP BY year;
```

### 强风天气统计

- 每年风速超过阈值(如10m/s)的天数

```
-- 每年风速超过阈值(如10m/s)的天数
SELECT 
    year,
    COUNT(DISTINCT CONCAT(month,'-',day)) AS high_wind_days
FROM weather_analysis
WHERE wind_speed > 10
GROUP BY year;
```

## 2. 趋势分析

### 2.1 温度长期趋势

```
-- 近5年每月平均温度变化
SELECT 
    year,
    month,
    ROUND(AVG(temperature), 2) AS avg_temp,
    ROUND(AVG(temperature) OVER (PARTITION BY month ORDER BY year 
         ROWS BETWEEN 4 PRECEDING AND CURRENT ROW), 2) AS 5yr_avg_temp
FROM weather_analysis
WHERE year BETWEEN 2019 AND 2023
GROUP BY year, month
ORDER BY year, month;
```

### 2.2 季节变化分析

```
-- 四季平均温度对比(北半球)
SELECT 
    year,
    CASE 
        WHEN month IN (3,4,5) THEN '春季'
        WHEN month IN (6,7,8) THEN '夏季'
        WHEN month IN (9,10,11) THEN '秋季'
        ELSE '冬季'
    END AS season,
    ROUND(AVG(temperature), 2) AS avg_temp
FROM weather_analysis
GROUP BY year, 
    CASE 
        WHEN month IN (3,4,5) THEN '春季'
        WHEN month IN (6,7,8) THEN '夏季'
        WHEN month IN (9,10,11) THEN '秋季'
        ELSE '冬季'
    END
ORDER BY year, season;
```

## 3. 相关性分析

### 3.1 温度-气压相关性

```
-- 每月温度与气压的相关系数
SELECT 
    year,
    month,
    ROUND(CORR(temperature, pressure), 4) AS temp_pressure_corr
FROM weather_analysis
GROUP BY year, month
ORDER BY year, month;
```

### 3.2 露点温度与相对湿度关系

```
-- 露点温度与温度差值的分布
SELECT 
    FLOOR((temperature - dew_point)/5)*5 AS temp_dewpoint_diff,
    COUNT(*) AS record_count
FROM weather_analysis
GROUP BY FLOOR((temperature - dew_point)/5)*5
ORDER BY temp_dewpoint_diff;
```

## 4. 天气现象统计

### 4.1 风向玫瑰图数据

```
-- 16方位风向频率统计
SELECT 
    CASE 
        WHEN wind_direction >= 348.75 OR wind_direction < 11.25 THEN 'N'
        WHEN wind_direction >= 11.25 AND wind_direction < 33.75 THEN 'NNE'
        -- 补充其他14个方位...
        ELSE 'NNW'
    END AS wind_dir,
    COUNT(*) AS frequency
FROM weather_analysis
GROUP BY CASE 
        WHEN wind_direction >= 348.75 OR wind_direction < 11.25 THEN 'N'
        WHEN wind_direction >= 11.25 AND wind_direction < 33.75 THEN 'NNE'
        -- 补充其他14个方位...
        ELSE 'NNW'
    END;
```

### 4.2 天气类型分类统计

```
-- 根据温湿度定义天气类型
SELECT 
    year,
    month,
    CASE
        WHEN temperature < 0 AND dew_point < -5 THEN '严寒干燥'
        WHEN temperature < 0 THEN '严寒'
        WHEN temperature < 10 AND humidity > 80 THEN '阴冷潮湿'
        -- 定义更多天气类型...
        ELSE '温和'
    END AS weather_type,
    COUNT(*) AS hours_count
FROM weather_analysis
GROUP BY year, month, 
    CASE
        WHEN temperature < 0 AND dew_point < -5 THEN '严寒干燥'
        WHEN temperature < 0 THEN '严寒'
        WHEN temperature < 10 AND humidity > 80 THEN '阴冷潮湿'
        ELSE '温和'
    END;
```